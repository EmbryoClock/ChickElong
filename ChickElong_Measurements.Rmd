---
title: "Elongation"
author: "Sara V. Ramalhete/Isabel Duarte"
date: "2024-10-31"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Install and load required packages

Install the required packages (RUN ONLY ONCE - Comment after first usage)

```{r}
install.packages("ggplot2")
install.packages("ggthemes")
install.packages("FactoMineR")
install.packages("factoextra")
install.packages('GGally')
install.packages("magrittr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("viridis")
install.packages("ggridges")
```

### Load Required packages

```{r}

library(ggplot2)
library(ggthemes)
library(FactoMineR)
library(factoextra)
library(GGally)
library(magrittr)
library(dplyr)
library(tidyverse)
library(viridis)
library(ggridges)
```
## Import the DataSet

```{r}

db_original_REF <- read.csv("./ChickElongQuant_input.csv", sep=";", dec=",")
```

## Scatterplot + lineplot for each measure (hue by embryo)

```{r}

db_original_REF$Embryo <- as.factor(db_original_REF$Embryo)


medidas <- function(a, b){
  
  # Creating the plot
  zz <- ggplot(data = db_original_REF, aes(x = Time, y = a, group = Embryo, color = Embryo)) +
        geom_hline(yintercept = seq(0, 8, 1), color = "gray94") +
    geom_vline(xintercept = seq(-10, 25, 5), color = "gray94") +
    geom_line(linewidth = 0.7) + 
    geom_point(size = 1) +
    theme_minimal() +
    ggtitle(b) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      axis.title = element_text(size = 11),
      axis.text = element_text(size = 10, colour = "black"),
      axis.line = element_line(color = "black"),
      axis.ticks = element_line(),
      legend.text = element_text(size = 11),
      legend.title = element_blank(),
      legend.key.size = unit(13, "point"),
      ) +scale_x_continuous(breaks = c(-10, -5, 0, 5, 10, 15, 20, 25))+
    xlab("Time (h)") + 
    ylab("Length (mm)")
  
  return(zz)
}


p1 <- medidas(db_original_REF$C.pPL, 'C-pPL') + guides(color='none') + theme(axis.title.x = element_blank())

p2 <- medidas(db_original_REF$C.PS, 'C-PS') + guides(color='none')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3 <- medidas(db_original_REF$C.N, 'C-N') + guides(color='none')+ theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4 <- medidas(db_original_REF$PSM, 'PSM') + guides(color='none') + theme(axis.title.x = element_blank())

p5 <- medidas(db_original_REF$SEG, 'SEG') + guides(color='none')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6 <- medidas(db_original_REF$C.HF, 'C-HF')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7 <- medidas(db_original_REF$C.Seg, 'C-Seg') + guides(color='none')

p8 <- medidas(db_original_REF$N.pPL, 'N-pPL') + guides(color='none')+theme(axis.title.y = element_blank())

p9 <- medidas(db_original_REF$N.PS, 'N-PS') + guides(color='none')+theme(axis.title.y = element_blank())


svg(filename="Length.svg",
    width=12, 
    height=10, 
    pointsize=14)


patchwork::wrap_plots(p1, p2, p3,
                      p4, p5, p6,
                      p7, p8, p9, ncol = 3)

dev.off()
```

## Scatterplot + lineplot for each measure (hue by culture)

```{r}

db_original_REF$CultureType <- as.factor(db_original_REF$CultureType)

medidasCT <- function(a, b){
  
  # Creating the plot
  zz <- ggplot(data = db_original_REF, aes(x = Time, y = a, group = Embryo, color = CultureType)) +
    geom_hline(yintercept = seq(0, 8, 1), color = "gray94") +
    geom_vline(xintercept = seq(-10, 25, 5), color = "gray94") +
    geom_line(linewidth = 0.7, alpha = 0.6) +
    geom_point(size = 0.7, alpha = 0.6) +
    theme_minimal() +
    ggtitle(b) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14),
      axis.title = element_text(size = 11),
      axis.text = element_text(size = 10, colour = "black"),
      axis.line = element_line(color = "black"),
      axis.ticks = element_line(),
      legend.text = element_text(size = 11),
      legend.title = element_blank(),
      legend.key.size = unit(13, "point")) +
    scale_x_continuous(breaks = c(-10, -5, 0, 5, 10, 15, 20, 25)) +
    xlab("Time (h)") + 
    ylab("Length (mm)")

  
  return(zz)
}


p1CT <- medidasCT(db_original_REF$C.pPL, 'C-pPL') + guides(color='none') + theme(axis.title.x = element_blank())

p2CT <- medidasCT(db_original_REF$C.PS, 'C-PS') + guides(color='none')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3CT <- medidasCT(db_original_REF$C.N, 'C-N') + guides(color='none')+ theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4CT <- medidasCT(db_original_REF$PSM, 'PSM') + guides(color='none') + theme(axis.title.x = element_blank())

p5CT <- medidasCT(db_original_REF$SEG, 'SEG') + guides(color='none')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6CT <- medidasCT(db_original_REF$C.HF, 'C-HF')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7CT <- medidasCT(db_original_REF$C.Seg, 'C-Seg') + guides(color='none')

p8CT <- medidasCT(db_original_REF$N.pPL, 'N-pPL') + guides(color='none')+theme(axis.title.y = element_blank())

p9CT <- medidasCT(db_original_REF$N.PS, 'N-PS') + guides(color='none')+theme(axis.title.y = element_blank())


svg(filename="LengthCT.svg",
    width=12, 
    height=10, 
    pointsize=14)


patchwork::wrap_plots(p1CT, p2CT, p3CT,
                      p4CT, p5CT, p6CT,
                      p7CT, p8CT, p9CT, ncol = 3)

dev.off()
```

## Scatter plot to normalized measures

All measures wee normalized by max

```{r}

db_Normalized <- db_original_REF

names <- colnames(db_Normalized)[3:11]

for (i in names) {
  
  for (j in 1:nrow(db_Normalized)) {
    
    db_Normalized[j,i] <- db_Normalized[j,i]/max(db_Normalized[,i], na.rm = T)
    
  }
  
}

medidas_nor <- function(x, y){
  
  zz <- ggplot(data=db_Normalized, aes(x=Time, y=x, group=Embryo))+ 
    geom_point(size=4, color="#C8C8C8", alpha=0.6)+ 
    geom_smooth(aes(group = 1), method = "lm", linetype = "solid", color = "black", se = FALSE)+
    theme_minimal() +
    ggtitle(y)+
    theme(plot.title = element_text(hjust = 0.5, size = 14),
          axis.title = element_text(size = 11),
          axis.text = element_text(size = 10, colour = "black"),
          axis.line = element_line(color = "black"),
          legend.text = element_text(size = 11),
          legend.title = element_blank()) +
    xlab("Time (h)")+ ylab("Ratio (a.u.)")+
    expand_limits(x=c(-10,26), y=c(0,1)) +
    scale_x_continuous(breaks = c(-10, -5, 0, 5, 10, 15, 20, 25))+
    scale_y_continuous(breaks = c(0.00, 0.25, 0.50, 0.75, 1.00))
  
  return(zz)
  
}


p1_n <- medidas_nor(db_Normalized$C.pPL, 'C-pPL')+theme(axis.title.x = element_blank())

p2_n <- medidas_nor(db_Normalized$C.PS, 'C-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3_n <- medidas_nor(db_Normalized$C.N, 'C-N')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4_n <- medidas_nor(db_Normalized$PSM, 'PSM')+theme(axis.title.x = element_blank())

p5_n <- medidas_nor(db_Normalized$SEG, 'SEG')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6_n <- medidas_nor(db_Normalized$C.HF, 'C-HF')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7_n <- medidas_nor(db_Normalized$C.Seg, 'C-Seg')

p8_n <- medidas_nor(db_Normalized$N.pPL, 'N-pPL')+theme(axis.title.y = element_blank())

p9_n <- medidas_nor(db_Normalized$N.PS, 'N-PS')+theme(axis.title.y = element_blank())


svg(filename="Ratio.svg", 
    width=12, 
    height=10, 
    pointsize=14)

patchwork::wrap_plots(p1_n, p2_n, p3_n,
                      p4_n, p5_n, p6_n,
                      p7_n, p8_n, p9_n, ncol = 3)

dev.off()
```

## PCA analysis

```{r}

output_pca <- PCA(db_original_REF[,colnames(db_original_REF) %in% names], scale.unit = TRUE, ncp = 5, graph = TRUE)

svg(filename="PCA.svg", 
    width=10, 
    height=10, 
    pointsize=14)

fviz_pca_var(output_pca, col.var = "black", repel=T)

dev.off()


```

## Correlation plot for each measure and time

```{r}

db_original_REF$Embryo <- as.character(db_original_REF$Embryo)

column_labels <- c("Time(h)", "C-pPL(mm)", "C-PS(mm)", "C-N(mm)", "N-pPL(mm)", "N-PS(mm)", "PSM(mm)", "C-Seg(mm)", "SEG(mm)", "C-HF(mm)")

gcor <- ggpairs(db_original_REF,
        columns = 2:11,
        columnLabels = column_labels,
        aes(color=Embryo),
        lower = list(continuous = wrap("smooth", size=1, se = F)),
        upper  = list(continuous = "blank"),
        diag  = list(continuous = "blankDiag"),
        axisLabels = c("show", "internal", "none"),
        switch = "both") +
  theme(strip.placement = "outside",
        strip.background =element_blank(),
        axis.text.x = element_text(size = 7),
        axis.title.x = element_text(size = 8),
        axis.text.y = element_text(size = 7),
        axis.title.y = element_text(size = 8))

svg(filename="Correlation.svg", 
    width=20, 
    height=20, 
    pointsize=14)

gcor

dev.off()

```

## Elongation rate for each measure

Prepare the function to return the elongation rate

```{r}

taxas_vector <- function(x){
  
  db_rate <- db_original_REF[,which(colnames(db_original_REF) %in% c("Time", "Embryo", x))]

db_rate <- na.omit(db_rate)

db_rate <- split(db_rate, db_rate$Embryo)

db_rate <- db_rate[sapply(db_rate, nrow) > 2]

for (i in 1:length(db_rate)) {
  db_rate[[i]] <- db_rate[[i]][which(db_rate[[i]]$Time==min(db_rate[[i]]$Time, na.rm = T) | db_rate[[i]]$Time==max(db_rate[[i]]$Time, na.rm = T)),]
  }



for (i in 1:length(db_rate)) {
  
  for (j in 1:nrow(db_rate[[i]])) {
    
    db_rate[[i]]$Teste[j] <- ifelse(db_rate[[i]]$Time[j]==min(db_rate[[i]]$Time, na.rm = T), "Min", "Max")
    
}
}



Taxa <- vector()

for (i in 1:length(db_rate)) {
  
  Taxa[i] <- (db_rate[[i]][which(db_rate[[i]]$Teste=="Max"),x] - db_rate[[i]][which(db_rate[[i]]$Teste=="Min"),x]) / (db_rate[[i]][which(db_rate[[i]]$Teste=="Max"),"Time"] - db_rate[[i]][which(db_rate[[i]]$Teste=="Min"),"Time"])
  
}

return(Taxa)

}
```

Setup the dataframe of elongation rate to each measure

```{r}

Final_taxa <- list()
length(Final_taxa) <- 9
names(Final_taxa) <- colnames(db_original_REF)[3:11]

Tabela <- NULL
valores <- NULL

for (i in names(Final_taxa)) {
  
  Final_taxa[[i]] <- as.data.frame(taxas_vector(i))
  Final_taxa[[i]][2] <- i
  colnames(Final_taxa[[i]]) <- c("Taxa", "Measure")
  
  c <- Final_taxa[[i]]
  
  Tabela <- rbind(c, Tabela)
  
  Quadro <- data.frame(Measure= i,
                       media = mean(Final_taxa[[i]]$Taxa),
                       desvio = sd(Final_taxa[[i]]$Taxa))
  
  valores <- rbind(Quadro, valores)
}

```

Plot elongation rate

```{r}

desired_order <- c('C.pPL', 'C.PS', 'C.N', 'PSM', 'SEG', 'C.HF', 'C.Seg', 'N.pPL', 'N.PS')

valores$Measure <- factor(valores$Measure, levels = desired_order)

library(ggplot2)

gtax <- ggplot(valores, aes(x=Measure, y=media, fill=Measure))+
  geom_bar(stat="identity")+
  scale_fill_manual(values = c("C.pPL" = "#3F6E9A", "C.PS" = "#9A68A4", "C.N" = "#F4A652", "PSM" = "#FFD0D2", 'SEG' = '#91FFFF', 'C.HF' = '#B59FEB', 'C.Seg' = '#FFE0B3', 'N.pPL' = '#7ABC6D', 'N.PS' = '#2A883E'))+
  geom_errorbar(aes(ymin=media-desvio, ymax=media+desvio), width=0.4, colour="black", alpha=0.9)+
  theme_minimal()+
  scale_x_discrete(labels = c("C.pPL" = "C-pPL", "C.PS" = "C-PS", "C.N" = "C-N", "PSM" = "PSM", 'SEG' = 'SEG', 'C.HF' = 'C-HF', 'C.Seg' = 'C-Seg', 'N.pPL' = 'N-pPL', 'N.PS' = 'N-PS')) +
  theme(legend.position="none",
        axis.text.x= element_text(colour = "black", size=11))+
  scale_y_continuous(name="Elongation Rate (mm/h)", limits=c(-0.15, 0.3))+
  labs(x = NULL)


svg(filename="ElongationRate.svg", 
    width=8, 
    height=6, 
    pointsize=14)

gtax

dev.off()
```

## Ridge line plots

Format dataset

```{r}

my.hh.order <- c("HH4","HH5","HH6","HH7","HH8","HH9","HH10")

db_original_REF %>%
  select(Embryo, HHStage, Time, C.pPL, C.PS, C.N, N.pPL, N.PS, PSM, C.Seg, SEG, C.HF) %>%
  filter(!is.na(HHStage)) %>%
  mutate_at(vars(HHStage), funs(paste0("HH", .))) %>%
  mutate(HHStage = factor(HHStage, levels = my.hh.order)) -> clean.embryo.length

clean.embryo.length %>% 
    group_by(Embryo) -> embryo.length.by.embryo

clean.embryo.length %>%
  group_by(HHStage) -> embryo.length.by.HHStage

# summary stats
count(embryo.length.by.embryo)
count(embryo.length.by.HHStage)
```

Create the ridge line plots for LENGTH (all 9 measures)

```{r}

list_plot <- list()

for (i in 1:9) {
  # Define plot titles
  my.labs <- c("C-pPL", "C-PS", 
               "C-N", "N-pPL", 
               "N-PS", "PSM", "C-Seg", 
               "SEG", "C-HF")
  
  # Dynamically reference the column for plotting
  col_name <- colnames(clean.embryo.length)[i+3]  # Adjust the column selection
  
  # Create the plot
  plot <- ggplot(clean.embryo.length, mapping=aes_string(x = col_name, y = "HHStage", fill = "HHStage")) +
    geom_density_ridges(alpha=0.75, rel_min_height = 0.001, scale = 2,
                        quantile_lines = TRUE, quantiles=2,
                        jittered_points = TRUE, position = "points_sina",
                        point_alpha = 0.8, point_size=0.5) +
    theme_ridges(grid = TRUE, center_axis_labels = TRUE) +
    theme(legend.position = "none", plot.title = element_text(hjust = 0.5)) +
    xlab("Length (mm)") +
    ylab('HH stage') +
    ggtitle(my.labs[i])
  
  # Save the plot in the list
  list_plot[[i]] <- plot  
  
  # Print the plot
  print(plot)
  
  # Save the plot as a PDF file
  ggsave(filename=paste0("ridgeplot_overlap", i, ".pdf"),
         plot = plot, width = 8.27, height = 5.83, units = "in",
         device = "pdf", path = "output/")
}

svg(filename="HHvsLen.svg", 
    width=12, 
    height=10, 
    pointsize=14)

patchwork::wrap_plots(list_plot[[1]]+theme(axis.title.x = element_blank()),
                      list_plot[[2]]+theme(axis.title.x = element_blank(), axis.title.y = element_blank()),
                      list_plot[[3]]+theme(axis.title.x = element_blank(), axis.title.y = element_blank()),
                      list_plot[[6]]+theme(axis.title.x = element_blank()),
                      list_plot[[8]]+theme(axis.title.x = element_blank(), axis.title.y = element_blank()),
                      list_plot[[9]]+theme(axis.title.x = element_blank(), axis.title.y = element_blank()),
                      list_plot[[7]],
                      list_plot[[4]]+theme(axis.title.y = element_blank()),
                      list_plot[[5]]+theme( axis.title.y = element_blank()), ncol = 3)

dev.off()
```

Create the ridge line plots for TIME

```{r}

plot.time <-
    ggplot(clean.embryo.length, mapping=aes(x = Time, y = HHStage, fill = HHStage)) +
    geom_density_ridges(alpha=0.75, rel_min_height = 0.001, scale = 1,
                        quantile_lines = TRUE, quantiles=2,
                        jittered_points = TRUE, position = "points_sina",
                        point_alpha = 0.8) +
    theme_ridges(grid = TRUE, center_axis_labels = TRUE)+
    theme(legend.position = "none") +
    scale_x_continuous(breaks = seq(-10, 25, 5)) +
    xlab("Time (h)") +
    ylab('HH stage') +
    ggtitle("Embryo time distribution per HH stage")
print(plot.time)
ggsave(plot.time,filename=paste0("ridgeplot_time",i,".pdf"),
       width = 8.27, height = 5.83, units = "in",
       device = "pdf", path="output/")
```

## Normalize for CHF

### According to the real time

```{r}

measu <- c("C.pPL", "C.PS", "C.N", "N.pPL", "N.PS", "PSM", "C.Seg", "SEG")

Tax_norm_CHF1 <- vector("list", length = 8)

for (i in 1:length(Tax_norm_CHF1)){
  Tax_norm_CHF1[[i]] <- db_original_REF
}

names(Tax_norm_CHF1) <- measu


for (i in measu){
  
  Tax_norm_CHF1[[i]]$New_Tax <- Tax_norm_CHF1[[i]][[i]]/Tax_norm_CHF1[[i]]$C.HF
  Tax_norm_CHF1[[i]] <- Tax_norm_CHF1[[i]][!is.na(Tax_norm_CHF1[[i]]$New_Tax), ]
  
}
```

Plot for each normalized measure

```{r}

tax_CHF_p <- function(database,measure){
  
  zz <- ggplot(data=database, aes(x=Time, y=New_Tax))+ 
    geom_point(size=4, color="#C8C8C8", alpha=0.6)+
    theme_minimal() +
    ggtitle(measure)+
    theme(plot.title = element_text(hjust = 0.5, size = 14),
          axis.title = element_text(size = 11),
          axis.text = element_text(size = 10, colour = "black"),
          axis.line = element_line(color = "black"),
          legend.text = element_text(size = 11),
          legend.title = element_blank()) +
    xlab("Time (h)")+ ylab("Ratio (a.u.)")+
    expand_limits(x=c(0,26)) +
    scale_x_continuous(breaks = c(0, 5, 10, 15, 20, 25))
  
  return(zz)
  
}


p1_CHF <- tax_CHF_p(Tax_norm_CHF1[["C.pPL"]], 'C-pPL')+theme(axis.title.x = element_blank())

p2_CHF <- tax_CHF_p(Tax_norm_CHF1[["C.PS"]], 'C-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3_CHF <- tax_CHF_p(Tax_norm_CHF1[["N.PS"]], 'N-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4_CHF <- tax_CHF_p(Tax_norm_CHF1[["PSM"]], 'PSM')+theme(axis.title.x = element_blank())

p5_CHF <- tax_CHF_p(Tax_norm_CHF1[["SEG"]], 'SEG')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6_CHF <- tax_CHF_p(Tax_norm_CHF1[["C.N"]], 'C-N')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7_CHF <- tax_CHF_p(Tax_norm_CHF1[["C.Seg"]], 'C-Seg')

p8_CHF <- tax_CHF_p(Tax_norm_CHF1[["N.pPL"]], 'N-pPL')+theme(axis.title.y = element_blank())


svg(filename="RatioCHF.svg", 
    width=12, 
    height=10, 
    pointsize=14)

patchwork::wrap_plots(p1_CHF, p2_CHF, p3_CHF,
                      p4_CHF, p5_CHF, p6_CHF,
                      p7_CHF, p8_CHF, ncol = 3)

dev.off()
```

```{r}

#Data frame for min and max time, range, standard deviation and coefficient of variation
Tax_CHF_t <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_CHF_t) <- measu
rownames(Tax_CHF_t) <- c("min", "max", "range", "sd", "cv")

for (i in measu){
  
  Tax_CHF_t["min",i] <- Tax_norm_CHF1[[i]]$New_Tax[which.min(Tax_norm_CHF1[[i]]$Time)]
  Tax_CHF_t["max",i] <- Tax_norm_CHF1[[i]]$New_Tax[which.max(Tax_norm_CHF1[[i]]$Time)]
  Tax_CHF_t["range",i] <- Tax_CHF_t["max",i] - Tax_CHF_t["min",i]
  Tax_CHF_t["sd",i] <- sd(Tax_norm_CHF1[[i]]$New_Tax)
  Tax_CHF_t["cv",i] <- sd(Tax_norm_CHF1[[i]]$New_Tax)/mean(Tax_norm_CHF1[[i]]$New_Tax)
  
}
```

### According to the HH stage

```{r}

#Calculate the median for each measure
Tax_norm_CHF2 <- db_original_REF[!is.na(db_original_REF$HHStage), ]
Tax_norm_CHF2 <- Tax_norm_CHF2[, colnames(Tax_norm_CHF2) %in% c(measu, "C.HF", "HHStage")]
Tax_norm_CHF2$HHStage <- as.factor(Tax_norm_CHF2$HHStage)

Tax_norm_CHF2_ <- aggregate(. ~ HHStage, data = Tax_norm_CHF2, FUN = function(x) median(x, na.rm = TRUE), na.action = na.pass)
Tax_norm_CHF2_ <- Tax_norm_CHF2_[!is.na(Tax_norm_CHF2_$C.HF),]


#Normalize according CHF
Tax_norm_CHF_HH <- vector("list", length = 8)

for (i in 1:length(Tax_norm_CHF_HH)){
  Tax_norm_CHF_HH[[i]] <- Tax_norm_CHF2_
}

names(Tax_norm_CHF_HH) <- measu


for (i in measu){
  
  Tax_norm_CHF_HH[[i]]$New_Tax <- Tax_norm_CHF_HH[[i]][[i]]/Tax_norm_CHF_HH[[i]]$C.HF
  Tax_norm_CHF_HH[[i]] <- Tax_norm_CHF_HH[[i]][!is.na(Tax_norm_CHF_HH[[i]]$New_Tax), ]
  
}


#Data frame for min and max hh, range, standard deviation and coefficient of variation
Tax_CHF_HH <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_CHF_HH) <- measu
rownames(Tax_CHF_HH) <- c("min", "max", "range", "sd", "cv")

for (i in measu){
  
  Tax_CHF_HH["min",i] <- Tax_norm_CHF_HH[[i]]$New_Tax[which.min(Tax_norm_CHF_HH[[i]]$HHStage)]
  Tax_CHF_HH["max",i] <- Tax_norm_CHF_HH[[i]]$New_Tax[which.max(Tax_norm_CHF_HH[[i]]$HHStage)]
  Tax_CHF_HH["range",i] <- Tax_CHF_HH["max",i] - Tax_CHF_HH["min",i]
  Tax_CHF_HH["sd",i] <- sd(Tax_norm_CHF_HH[[i]]$New_Tax)
  Tax_CHF_HH["cv",i] <- sd(Tax_norm_CHF_HH[[i]]$New_Tax)/mean(Tax_norm_CHF_HH[[i]]$New_Tax)
  
}
```

## Normalize for CSeg

### According to the real time

```{r}

measu_Cseg <- c("C.pPL", "C.PS", "C.N", "N.pPL", "N.PS", "PSM", "C.HF", "SEG")

Tax_norm_CSeg1 <- vector("list", length = 8)

for (i in 1:length(Tax_norm_CSeg1)){
  Tax_norm_CSeg1[[i]] <- db_original_REF
}

names(Tax_norm_CSeg1) <- measu_Cseg


for (i in measu_Cseg){
  
  Tax_norm_CSeg1[[i]]$New_Tax <- Tax_norm_CSeg1[[i]][[i]]/Tax_norm_CSeg1[[i]]$C.Seg
  Tax_norm_CSeg1[[i]] <- Tax_norm_CSeg1[[i]][!is.na(Tax_norm_CSeg1[[i]]$New_Tax), ]
  
}
```

```{r}

p1_CSeg <- tax_CHF_p(Tax_norm_CSeg1[["C.pPL"]], 'C-pPL')+theme(axis.title.x = element_blank())

p2_CSeg <- tax_CHF_p(Tax_norm_CSeg1[["C.PS"]], 'C-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3_CSeg <- tax_CHF_p(Tax_norm_CSeg1[["N.PS"]], 'N-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4_CSeg <- tax_CHF_p(Tax_norm_CSeg1[["PSM"]], 'PSM')+theme(axis.title.x = element_blank())

p5_CSeg <- tax_CHF_p(Tax_norm_CSeg1[["SEG"]], 'SEG')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6_CSeg <- tax_CHF_p(Tax_norm_CSeg1[["C.N"]], 'C-N')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7_CSeg <- tax_CHF_p(Tax_norm_CSeg1[["C.HF"]], 'C-HF')

p8_CSeg <- tax_CHF_p(Tax_norm_CSeg1[["N.pPL"]], 'N-pPL')+theme(axis.title.y = element_blank())


svg(filename="RatioCseg.svg", 
    width=12, 
    height=10, 
    pointsize=14)

patchwork::wrap_plots(p1_CSeg, p2_CSeg, p3_CSeg,
                      p4_CSeg, p5_CSeg, p6_CSeg,
                      p7_CSeg, p8_CSeg, ncol = 3)

dev.off()
```

```{r}

#Data frame for min and max time, range, standard deviation and coefficient of variation
Tax_CSeg_t <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_CSeg_t) <- measu_Cseg
rownames(Tax_CSeg_t) <- c("min", "max", "range", "sd", "cv")

for (i in measu_Cseg){
  
  Tax_CSeg_t["min",i] <- Tax_norm_CSeg1[[i]]$New_Tax[which.min(Tax_norm_CSeg1[[i]]$Time)]
  Tax_CSeg_t["max",i] <- Tax_norm_CSeg1[[i]]$New_Tax[which.max(Tax_norm_CSeg1[[i]]$Time)]
  Tax_CSeg_t["range",i] <- Tax_CSeg_t["max",i] - Tax_CSeg_t["min",i]
  Tax_CSeg_t["sd",i] <- sd(Tax_norm_CSeg1[[i]]$New_Tax)
  Tax_CSeg_t["cv",i] <- sd(Tax_norm_CSeg1[[i]]$New_Tax)/mean(Tax_norm_CSeg1[[i]]$New_Tax)
  
}
```

### According to the HH stage

```{r}

#Calculate the median for each measure
Tax_norm_CSeg2 <- db_original_REF[!is.na(db_original_REF$HHStage), ]
Tax_norm_CSeg2 <- Tax_norm_CSeg2[, colnames(Tax_norm_CSeg2) %in% c(measu_Cseg, "C.Seg", "HHStage")]
Tax_norm_CSeg2$HHStage <- as.factor(Tax_norm_CSeg2$HHStage)

Tax_norm_CSeg2_ <- aggregate(. ~ HHStage, data = Tax_norm_CSeg2, FUN = function(x) median(x, na.rm = TRUE), na.action = na.pass)
Tax_norm_CSeg2_ <- Tax_norm_CSeg2_[!is.na(Tax_norm_CSeg2_$C.Seg),]


#Normalize according CSeg
Tax_norm_CSeg_HH <- vector("list", length = 8)

for (i in 1:length(Tax_norm_CSeg_HH)){
  Tax_norm_CSeg_HH[[i]] <- Tax_norm_CSeg2_
}

names(Tax_norm_CSeg_HH) <- measu_Cseg


for (i in measu_Cseg){
  
  Tax_norm_CSeg_HH[[i]]$New_Tax <- Tax_norm_CSeg_HH[[i]][[i]]/Tax_norm_CSeg_HH[[i]]$C.Seg
  Tax_norm_CSeg_HH[[i]] <- Tax_norm_CSeg_HH[[i]][!is.na(Tax_norm_CSeg_HH[[i]]$New_Tax), ]
  
}


#Data frame for min and max hh, range, standard deviation and coefficient of variation
Tax_CSeg_HH <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_CSeg_HH) <- measu_Cseg
rownames(Tax_CSeg_HH) <- c("min", "max", "range", "sd", "cv")

for (i in measu_Cseg){
  
  Tax_CSeg_HH["min",i] <- Tax_norm_CSeg_HH[[i]]$New_Tax[which.min(Tax_norm_CSeg_HH[[i]]$HHStage)]
  Tax_CSeg_HH["max",i] <- Tax_norm_CSeg_HH[[i]]$New_Tax[which.max(Tax_norm_CSeg_HH[[i]]$HHStage)]
  Tax_CSeg_HH["range",i] <- Tax_CSeg_HH["max",i] - Tax_CSeg_HH["min",i]
  Tax_CSeg_HH["sd",i] <- sd(Tax_norm_CSeg_HH[[i]]$New_Tax)
  Tax_CSeg_HH["cv",i] <- sd(Tax_norm_CSeg_HH[[i]]$New_Tax)/mean(Tax_norm_CSeg_HH[[i]]$New_Tax)
  
}
```

## Normalize for C.N

### According to the real time

```{r}

measu_CN <- c("C.pPL", "C.PS", "C.Seg", "N.pPL", "N.PS", "PSM", "C.HF", "SEG")

Tax_norm_CN1 <- vector("list", length = 8)

for (i in 1:length(Tax_norm_CN1)){
  Tax_norm_CN1[[i]] <- db_original_REF
}

names(Tax_norm_CN1) <- measu_CN


for (i in measu_CN){
  
  Tax_norm_CN1[[i]]$New_Tax <- Tax_norm_CN1[[i]][[i]]/Tax_norm_CN1[[i]]$C.N
  Tax_norm_CN1[[i]] <- Tax_norm_CN1[[i]][!is.na(Tax_norm_CN1[[i]]$New_Tax), ]
  
}
```

```{r}

p1_CN <- tax_CHF_p(Tax_norm_CN1[["C.pPL"]], 'C-pPL')+theme(axis.title.x = element_blank())

p2_CN <- tax_CHF_p(Tax_norm_CN1[["C.PS"]], 'C-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3_CN <- tax_CHF_p(Tax_norm_CN1[["N.PS"]], 'N-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4_CN <- tax_CHF_p(Tax_norm_CN1[["PSM"]], 'PSM')+theme(axis.title.x = element_blank())

p5_CN <- tax_CHF_p(Tax_norm_CN1[["SEG"]], 'SEG')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6_CN <- tax_CHF_p(Tax_norm_CN1[["C.Seg"]], 'C-Seg')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7_CN <- tax_CHF_p(Tax_norm_CN1[["C.HF"]], 'C-HF')

p8_CN <- tax_CHF_p(Tax_norm_CN1[["N.pPL"]], 'N-pPL')+theme(axis.title.y = element_blank())


svg(filename="RatioCN.svg", 
    width=12, 
    height=10, 
    pointsize=14)

patchwork::wrap_plots(p1_CN, p2_CN, p3_CN,
                      p4_CN, p5_CN, p6_CN,
                      p7_CN, p8_CN, ncol = 3)

dev.off()
```

```{r}

#Data frame for min and max time, range, standard deviation and coefficient of variation
Tax_CN_t <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_CN_t) <- measu_CN
rownames(Tax_CN_t) <- c("min", "max", "range", "sd", "cv")

for (i in measu_CN){
  
  Tax_CN_t["min",i] <- Tax_norm_CN1[[i]]$New_Tax[which.min(Tax_norm_CN1[[i]]$Time)]
  Tax_CN_t["max",i] <- Tax_norm_CN1[[i]]$New_Tax[which.max(Tax_norm_CN1[[i]]$Time)]
  Tax_CN_t["range",i] <- Tax_CN_t["max",i] - Tax_CN_t["min",i]
  Tax_CN_t["sd",i] <- sd(Tax_norm_CN1[[i]]$New_Tax)
  Tax_CN_t["cv",i] <- sd(Tax_norm_CN1[[i]]$New_Tax)/mean(Tax_norm_CN1[[i]]$New_Tax)
  
}
```

### According to the HH stage

```{r}


#Calculate the median for each measure
Tax_norm_CN2 <- db_original_REF[!is.na(db_original_REF$HHStage), ]
Tax_norm_CN2 <- Tax_norm_CN2[, colnames(Tax_norm_CN2) %in% c(measu_CN, "C.N", "HHStage")]
Tax_norm_CN2$HHStage <- as.factor(Tax_norm_CN2$HHStage)

Tax_norm_CN2_ <- aggregate(. ~ HHStage, data = Tax_norm_CN2, FUN = function(x) median(x, na.rm = TRUE), na.action = na.pass)
Tax_norm_CN2_ <- Tax_norm_CN2_[!is.na(Tax_norm_CN2_$C.N),]


#Normalize according CN
Tax_norm_CN_HH <- vector("list", length = 8)

for (i in 1:length(Tax_norm_CN_HH)){
  Tax_norm_CN_HH[[i]] <- Tax_norm_CN2_
}

names(Tax_norm_CN_HH) <- measu_CN


for (i in measu_CN){
  
  Tax_norm_CN_HH[[i]]$New_Tax <- Tax_norm_CN_HH[[i]][[i]]/Tax_norm_CN_HH[[i]]$C.N
  Tax_norm_CN_HH[[i]] <- Tax_norm_CN_HH[[i]][!is.na(Tax_norm_CN_HH[[i]]$New_Tax), ]
  
}


#Data frame for min and max hh, range, standard deviation and coefficient of variation
Tax_CN_HH <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_CN_HH) <- measu_CN
rownames(Tax_CN_HH) <- c("min", "max", "range", "sd", "cv")

for (i in measu_CN){
  
  Tax_CN_HH["min",i] <- Tax_norm_CN_HH[[i]]$New_Tax[which.min(Tax_norm_CN_HH[[i]]$HHStage)]
  Tax_CN_HH["max",i] <- Tax_norm_CN_HH[[i]]$New_Tax[which.max(Tax_norm_CN_HH[[i]]$HHStage)]
  Tax_CN_HH["range",i] <- Tax_CN_HH["max",i] - Tax_CN_HH["min",i]
  Tax_CN_HH["sd",i] <- sd(Tax_norm_CN_HH[[i]]$New_Tax)
  Tax_CN_HH["cv",i] <- sd(Tax_norm_CN_HH[[i]]$New_Tax)/mean(Tax_norm_CN_HH[[i]]$New_Tax)
  
}
```

## Normalize for C.pPL

### According to the real time

```{r}

measu_CpPL <- c("C.N", "C.PS", "C.Seg", "N.pPL", "N.PS", "PSM", "C.HF", "SEG")

Tax_norm_CpPL1 <- vector("list", length = 8)

for (i in 1:length(Tax_norm_CpPL1)){
  Tax_norm_CpPL1[[i]] <- db_original_REF
}

names(Tax_norm_CpPL1) <- measu_CpPL


for (i in measu_CpPL){
  
  Tax_norm_CpPL1[[i]]$New_Tax <- Tax_norm_CpPL1[[i]][[i]]/Tax_norm_CpPL1[[i]]$C.pPL
  Tax_norm_CpPL1[[i]] <- Tax_norm_CpPL1[[i]][!is.na(Tax_norm_CpPL1[[i]]$New_Tax), ]
  
}

```

```{r}

p1_CpPL <- tax_CHF_p(Tax_norm_CpPL1[["C.N"]], 'C-N')+theme(axis.title.x = element_blank())

p2_CpPL <- tax_CHF_p(Tax_norm_CpPL1[["C.PS"]], 'C-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3_CpPL <- tax_CHF_p(Tax_norm_CpPL1[["N.PS"]], 'N-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4_CpPL <- tax_CHF_p(Tax_norm_CpPL1[["PSM"]], 'PSM')+theme(axis.title.x = element_blank())

p5_CpPL <- tax_CHF_p(Tax_norm_CpPL1[["SEG"]], 'SEG')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6_CpPL <- tax_CHF_p(Tax_norm_CpPL1[["C.Seg"]], 'C-Seg')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7_CpPL <- tax_CHF_p(Tax_norm_CpPL1[["C.HF"]], 'C-HF')

p8_CpPL <- tax_CHF_p(Tax_norm_CpPL1[["N.pPL"]], 'N-pPL')+theme(axis.title.y = element_blank())


svg(filename="RatioCpPL.svg", 
    width=12, 
    height=10, 
    pointsize=14)

patchwork::wrap_plots(p1_CpPL, p2_CpPL, p3_CpPL,
                      p4_CpPL, p5_CpPL, p6_CpPL,
                      p7_CpPL, p8_CpPL, ncol = 3)

dev.off()
```

```{r}

#Data frame for min and max time, range, standard deviation and coefficient of variation
Tax_CpPL_t <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_CpPL_t) <- measu_CpPL
rownames(Tax_CpPL_t) <- c("min", "max", "range", "sd", "cv")

for (i in measu_CpPL){
  
  Tax_CpPL_t["min",i] <- Tax_norm_CpPL1[[i]]$New_Tax[which.min(Tax_norm_CpPL1[[i]]$Time)]
  Tax_CpPL_t["max",i] <- Tax_norm_CpPL1[[i]]$New_Tax[which.max(Tax_norm_CpPL1[[i]]$Time)]
  Tax_CpPL_t["range",i] <- Tax_CpPL_t["max",i] - Tax_CpPL_t["min",i]
  Tax_CpPL_t["sd",i] <- sd(Tax_norm_CpPL1[[i]]$New_Tax)
  Tax_CpPL_t["cv",i] <- sd(Tax_norm_CpPL1[[i]]$New_Tax)/mean(Tax_norm_CpPL1[[i]]$New_Tax)
  
}
```

### According to the HH stage

```{r}

#Calculate the median for each measure
Tax_norm_CpPL2 <- db_original_REF[!is.na(db_original_REF$HHStage), ]
Tax_norm_CpPL2 <- Tax_norm_CpPL2[, colnames(Tax_norm_CpPL2) %in% c(measu_CpPL, "C.pPL", "HHStage")]
Tax_norm_CpPL2$HHStage <- as.factor(Tax_norm_CpPL2$HHStage)

Tax_norm_CpPL2_ <- aggregate(. ~ HHStage, data = Tax_norm_CpPL2, FUN = function(x) median(x, na.rm = TRUE), na.action = na.pass)
Tax_norm_CpPL2_ <- Tax_norm_CpPL2_[!is.na(Tax_norm_CpPL2_$C.pPL),]


#Normalize according CpPL
Tax_norm_CpPL_HH <- vector("list", length = 8)

for (i in 1:length(Tax_norm_CpPL_HH)){
  Tax_norm_CpPL_HH[[i]] <- Tax_norm_CpPL2_
}

names(Tax_norm_CpPL_HH) <- measu_CpPL


for (i in measu_CpPL){
  
  Tax_norm_CpPL_HH[[i]]$New_Tax <- Tax_norm_CpPL_HH[[i]][[i]]/Tax_norm_CpPL_HH[[i]]$C.pPL
  Tax_norm_CpPL_HH[[i]] <- Tax_norm_CpPL_HH[[i]][!is.na(Tax_norm_CpPL_HH[[i]]$New_Tax), ]
  
}


#Data frame for min and max hh, range, standard deviation and coefficient of variation
Tax_CpPL_HH <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_CpPL_HH) <- measu_CpPL
rownames(Tax_CpPL_HH) <- c("min", "max", "range", "sd", "cv")

for (i in measu_CpPL){
  
  Tax_CpPL_HH["min",i] <- Tax_norm_CpPL_HH[[i]]$New_Tax[which.min(Tax_norm_CpPL_HH[[i]]$HHStage)]
  Tax_CpPL_HH["max",i] <- Tax_norm_CpPL_HH[[i]]$New_Tax[which.max(Tax_norm_CpPL_HH[[i]]$HHStage)]
  Tax_CpPL_HH["range",i] <- Tax_CpPL_HH["max",i] - Tax_CpPL_HH["min",i]
  Tax_CpPL_HH["sd",i] <- sd(Tax_norm_CpPL_HH[[i]]$New_Tax)
  Tax_CpPL_HH["cv",i] <- sd(Tax_norm_CpPL_HH[[i]]$New_Tax)/mean(Tax_norm_CpPL_HH[[i]]$New_Tax)
  
}
```

## Normalize for C.PS

### According to the real time

```{r}

measu_CPS <- c("C.N", "C.pPL", "C.Seg", "N.pPL", "N.PS", "PSM", "C.HF", "SEG")

Tax_norm_CPS1 <- vector("list", length = 8)

for (i in 1:length(Tax_norm_CPS1)){
  Tax_norm_CPS1[[i]] <- db_original_REF
}

names(Tax_norm_CPS1) <- measu_CPS


for (i in measu_CPS){
  
  Tax_norm_CPS1[[i]]$New_Tax <- Tax_norm_CPS1[[i]][[i]]/Tax_norm_CPS1[[i]]$C.PS
  Tax_norm_CPS1[[i]] <- Tax_norm_CPS1[[i]][!is.na(Tax_norm_CPS1[[i]]$New_Tax), ]
  
}
```

```{r}

p1_CPS <- tax_CHF_p(Tax_norm_CPS1[["C.N"]], 'C-N')+theme(axis.title.x = element_blank())

p2_CPS <- tax_CHF_p(Tax_norm_CPS1[["C.pPL"]], 'C-pPL')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3_CPS <- tax_CHF_p(Tax_norm_CPS1[["N.PS"]], 'N-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4_CPS <- tax_CHF_p(Tax_norm_CPS1[["PSM"]], 'PSM')+theme(axis.title.x = element_blank())

p5_CPS <- tax_CHF_p(Tax_norm_CPS1[["SEG"]], 'SEG')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6_CPS <- tax_CHF_p(Tax_norm_CPS1[["C.Seg"]], 'C-Seg')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7_CPS <- tax_CHF_p(Tax_norm_CPS1[["C.HF"]], 'C-HF')

p8_CPS <- tax_CHF_p(Tax_norm_CPS1[["N.pPL"]], 'N-pPL')+theme(axis.title.y = element_blank())


svg(filename="RatioCPS.svg", 
    width=12, 
    height=10, 
    pointsize=14)

patchwork::wrap_plots(p1_CPS, p2_CPS, p3_CPS,
                      p4_CPS, p5_CPS, p6_CPS,
                      p7_CPS, p8_CPS, ncol = 3)

dev.off()
```

```{r}

#Data frame for min and max time, range, standard deviation and coefficient of variation
Tax_CPS_t <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_CPS_t) <- measu_CPS
rownames(Tax_CPS_t) <- c("min", "max", "range", "sd", "cv")

for (i in measu_CPS){
  
  Tax_CPS_t["min",i] <- Tax_norm_CPS1[[i]]$New_Tax[which.min(Tax_norm_CPS1[[i]]$Time)]
  Tax_CPS_t["max",i] <- Tax_norm_CPS1[[i]]$New_Tax[which.max(Tax_norm_CPS1[[i]]$Time)]
  Tax_CPS_t["range",i] <- Tax_CPS_t["max",i] - Tax_CPS_t["min",i]
  Tax_CPS_t["sd",i] <- sd(Tax_norm_CPS1[[i]]$New_Tax)
  Tax_CPS_t["cv",i] <- sd(Tax_norm_CPS1[[i]]$New_Tax)/mean(Tax_norm_CPS1[[i]]$New_Tax)
  
}
```

### According to the HH stage

```{r}

#Calculate the median for each measure
Tax_norm_CPS2 <- db_original_REF[!is.na(db_original_REF$HHStage), ]
Tax_norm_CPS2 <- Tax_norm_CPS2[, colnames(Tax_norm_CPS2) %in% c(measu_CPS, "C.PS", "HHStage")]
Tax_norm_CPS2$HHStage <- as.factor(Tax_norm_CPS2$HHStage)

Tax_norm_CPS2_ <- aggregate(. ~ HHStage, data = Tax_norm_CPS2, FUN = function(x) median(x, na.rm = TRUE), na.action = na.pass)
Tax_norm_CPS2_ <- Tax_norm_CPS2_[!is.na(Tax_norm_CPS2_$C.PS),]


#Normalize according CPS
Tax_norm_CPS_HH <- vector("list", length = 8)

for (i in 1:length(Tax_norm_CPS_HH)){
  Tax_norm_CPS_HH[[i]] <- Tax_norm_CPS2_
}

names(Tax_norm_CPS_HH) <- measu_CPS


for (i in measu_CPS){
  
  Tax_norm_CPS_HH[[i]]$New_Tax <- Tax_norm_CPS_HH[[i]][[i]]/Tax_norm_CPS_HH[[i]]$C.PS
  Tax_norm_CPS_HH[[i]] <- Tax_norm_CPS_HH[[i]][!is.na(Tax_norm_CPS_HH[[i]]$New_Tax), ]
  
}


#Data frame for min and max hh, range, standard deviation and coefficient of variation
Tax_CPS_HH <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_CPS_HH) <- measu_CPS
rownames(Tax_CPS_HH) <- c("min", "max", "range", "sd", "cv")

for (i in measu_CPS){
  
  Tax_CPS_HH["min",i] <- Tax_norm_CPS_HH[[i]]$New_Tax[which.min(Tax_norm_CPS_HH[[i]]$HHStage)]
  Tax_CPS_HH["max",i] <- Tax_norm_CPS_HH[[i]]$New_Tax[which.max(Tax_norm_CPS_HH[[i]]$HHStage)]
  Tax_CPS_HH["range",i] <- Tax_CPS_HH["max",i] - Tax_CPS_HH["min",i]
  Tax_CPS_HH["sd",i] <- sd(Tax_norm_CPS_HH[[i]]$New_Tax)
  Tax_CPS_HH["cv",i] <- sd(Tax_norm_CPS_HH[[i]]$New_Tax)/mean(Tax_norm_CPS_HH[[i]]$New_Tax)
  
}
```

## Normalize for N.pPL

### According to the real time

```{r}

measu_NpPL <- c("C.N", "C.pPL", "C.Seg", "C.PS", "N.PS", "PSM", "C.HF", "SEG")

Tax_norm_NpPL1 <- vector("list", length = 8)

for (i in 1:length(Tax_norm_NpPL1)){
  Tax_norm_NpPL1[[i]] <- db_original_REF
}

names(Tax_norm_NpPL1) <- measu_NpPL


for (i in measu_NpPL){
  
  Tax_norm_NpPL1[[i]]$New_Tax <- Tax_norm_NpPL1[[i]][[i]]/Tax_norm_NpPL1[[i]]$N.pPL
  Tax_norm_NpPL1[[i]] <- Tax_norm_NpPL1[[i]][!is.na(Tax_norm_NpPL1[[i]]$New_Tax), ]
  
}
```

```{r}

p1_NpPL <- tax_CHF_p(Tax_norm_NpPL1[["C.N"]], 'C-N')+theme(axis.title.x = element_blank())

p2_NpPL <- tax_CHF_p(Tax_norm_NpPL1[["C.pPL"]], 'C-pPL')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3_NpPL <- tax_CHF_p(Tax_norm_NpPL1[["N.PS"]], 'N-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4_NpPL <- tax_CHF_p(Tax_norm_NpPL1[["PSM"]], 'PSM')+theme(axis.title.x = element_blank())

p5_NpPL <- tax_CHF_p(Tax_norm_NpPL1[["SEG"]], 'SEG')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6_NpPL <- tax_CHF_p(Tax_norm_NpPL1[["C.Seg"]], 'C-Seg')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7_NpPL <- tax_CHF_p(Tax_norm_NpPL1[["C.HF"]], 'C-HF')

p8_NpPL <- tax_CHF_p(Tax_norm_NpPL1[["C.PS"]], 'C-PS')+theme(axis.title.y = element_blank())


svg(filename="RatioNpPL.svg", 
    width=12, 
    height=10, 
    pointsize=14)

patchwork::wrap_plots(p1_NpPL, p2_NpPL, p3_NpPL,
                      p4_NpPL, p5_NpPL, p6_NpPL,
                      p7_NpPL, p8_NpPL, ncol = 3)

dev.off()
```

```{r}

#Data frame for min and max time, range, standard deviation and coefficient of variation
Tax_NpPL_t <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_NpPL_t) <- measu_NpPL
rownames(Tax_NpPL_t) <- c("min", "max", "range", "sd", "cv")

for (i in measu_NpPL){
  
  Tax_NpPL_t["min",i] <- Tax_norm_NpPL1[[i]]$New_Tax[which.min(Tax_norm_NpPL1[[i]]$Time)]
  Tax_NpPL_t["max",i] <- Tax_norm_NpPL1[[i]]$New_Tax[which.max(Tax_norm_NpPL1[[i]]$Time)]
  Tax_NpPL_t["range",i] <- Tax_NpPL_t["max",i] - Tax_NpPL_t["min",i]
  Tax_NpPL_t["sd",i] <- sd(Tax_norm_NpPL1[[i]]$New_Tax)
  Tax_NpPL_t["cv",i] <- sd(Tax_norm_NpPL1[[i]]$New_Tax)/mean(Tax_norm_NpPL1[[i]]$New_Tax)
  
}
```

### According to the HH stage

```{r}


#Calculate the median for each measure
Tax_norm_NpPL2 <- db_original_REF[!is.na(db_original_REF$HHStage), ]
Tax_norm_NpPL2 <- Tax_norm_NpPL2[, colnames(Tax_norm_NpPL2) %in% c(measu_NpPL, "N.pPL", "HHStage")]
Tax_norm_NpPL2$HHStage <- as.factor(Tax_norm_NpPL2$HHStage)

Tax_norm_NpPL2_ <- aggregate(. ~ HHStage, data = Tax_norm_NpPL2, FUN = function(x) median(x, na.rm = TRUE), na.action = na.pass)
Tax_norm_NpPL2_ <- Tax_norm_NpPL2_[!is.na(Tax_norm_NpPL2_$N.pPL),]


#Normalize according NpPL
Tax_norm_NpPL_HH <- vector("list", length = 8)

for (i in 1:length(Tax_norm_NpPL_HH)){
  Tax_norm_NpPL_HH[[i]] <- Tax_norm_NpPL2_
}

names(Tax_norm_NpPL_HH) <- measu_NpPL


for (i in measu_NpPL){
  
  Tax_norm_NpPL_HH[[i]]$New_Tax <- Tax_norm_NpPL_HH[[i]][[i]]/Tax_norm_NpPL_HH[[i]]$N.pPL
  Tax_norm_NpPL_HH[[i]] <- Tax_norm_NpPL_HH[[i]][!is.na(Tax_norm_NpPL_HH[[i]]$New_Tax), ]
  
}


#Data frame for min and max hh, range, standard deviation and coefficient of variation
Tax_NpPL_HH <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_NpPL_HH) <- measu_NpPL
rownames(Tax_NpPL_HH) <- c("min", "max", "range", "sd", "cv")

for (i in measu_NpPL){
  
  Tax_NpPL_HH["min",i] <- Tax_norm_NpPL_HH[[i]]$New_Tax[which.min(Tax_norm_NpPL_HH[[i]]$HHStage)]
  Tax_NpPL_HH["max",i] <- Tax_norm_NpPL_HH[[i]]$New_Tax[which.max(Tax_norm_NpPL_HH[[i]]$HHStage)]
  Tax_NpPL_HH["range",i] <- Tax_NpPL_HH["max",i] - Tax_NpPL_HH["min",i]
  Tax_NpPL_HH["sd",i] <- sd(Tax_norm_NpPL_HH[[i]]$New_Tax)
  Tax_NpPL_HH["cv",i] <- sd(Tax_norm_NpPL_HH[[i]]$New_Tax)/mean(Tax_norm_NpPL_HH[[i]]$New_Tax)
  
}
```

## Normalize for PSM

### According to the real time

```{r}

measu_PSM <- c("C.N", "C.pPL", "C.Seg", "C.PS", "N.PS", "N.pPL", "C.HF", "SEG")

Tax_norm_PSM1 <- vector("list", length = 8)

for (i in 1:length(Tax_norm_PSM1)){
  Tax_norm_PSM1[[i]] <- db_original_REF
}

names(Tax_norm_PSM1) <- measu_PSM


for (i in measu_PSM){
  
  Tax_norm_PSM1[[i]]$New_Tax <- Tax_norm_PSM1[[i]][[i]]/Tax_norm_PSM1[[i]]$PSM
  Tax_norm_PSM1[[i]] <- Tax_norm_PSM1[[i]][!is.na(Tax_norm_PSM1[[i]]$New_Tax), ]
  
}
```

```{r}

p1_PSM <- tax_CHF_p(Tax_norm_PSM1[["C.N"]], 'C-N')+theme(axis.title.x = element_blank())

p2_PSM <- tax_CHF_p(Tax_norm_PSM1[["C.pPL"]], 'C-pPL')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3_PSM <- tax_CHF_p(Tax_norm_PSM1[["N.PS"]], 'N-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4_PSM <- tax_CHF_p(Tax_norm_PSM1[["N.pPL"]], 'N-pPL')+theme(axis.title.x = element_blank())

p5_PSM <- tax_CHF_p(Tax_norm_PSM1[["SEG"]], 'SEG')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6_PSM <- tax_CHF_p(Tax_norm_PSM1[["C.Seg"]], 'C-Seg')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7_PSM <- tax_CHF_p(Tax_norm_PSM1[["C.HF"]], 'C-HF')

p8_PSM <- tax_CHF_p(Tax_norm_PSM1[["C.PS"]], 'C-PS')+theme(axis.title.y = element_blank())


svg(filename="RatioPSM.svg", 
    width=12, 
    height=10, 
    pointsize=14)

patchwork::wrap_plots(p1_PSM, p2_PSM, p3_PSM,
                      p4_PSM, p5_PSM, p6_PSM,
                      p7_PSM, p8_PSM, ncol = 3)

dev.off()
```

```{r}

#Data frame for min and max time, range, standard deviation and coefficient of variation
Tax_PSM_t <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_PSM_t) <- measu_PSM
rownames(Tax_PSM_t) <- c("min", "max", "range", "sd", "cv")

for (i in measu_PSM){
  
  Tax_PSM_t["min",i] <- Tax_norm_PSM1[[i]]$New_Tax[which.min(Tax_norm_PSM1[[i]]$Time)]
  Tax_PSM_t["max",i] <- Tax_norm_PSM1[[i]]$New_Tax[which.max(Tax_norm_PSM1[[i]]$Time)]
  Tax_PSM_t["range",i] <- Tax_PSM_t["max",i] - Tax_PSM_t["min",i]
  Tax_PSM_t["sd",i] <- sd(Tax_norm_PSM1[[i]]$New_Tax)
  Tax_PSM_t["cv",i] <- sd(Tax_norm_PSM1[[i]]$New_Tax)/mean(Tax_norm_PSM1[[i]]$New_Tax)
  
}
```

### According to the HH stage

```{r}

#Calculate the median for each measure
Tax_norm_PSM2 <- db_original_REF[!is.na(db_original_REF$HHStage), ]
Tax_norm_PSM2 <- Tax_norm_PSM2[, colnames(Tax_norm_PSM2) %in% c(measu_PSM, "PSM", "HHStage")]
Tax_norm_PSM2$HHStage <- as.factor(Tax_norm_PSM2$HHStage)

Tax_norm_PSM2_ <- aggregate(. ~ HHStage, data = Tax_norm_PSM2, FUN = function(x) median(x, na.rm = TRUE), na.action = na.pass)
Tax_norm_PSM2_ <- Tax_norm_PSM2_[!is.na(Tax_norm_PSM2_$PSM),]


#Normalize according PSM
Tax_norm_PSM_HH <- vector("list", length = 8)

for (i in 1:length(Tax_norm_PSM_HH)){
  Tax_norm_PSM_HH[[i]] <- Tax_norm_PSM2_
}

names(Tax_norm_PSM_HH) <- measu_PSM


for (i in measu_PSM){
  
  Tax_norm_PSM_HH[[i]]$New_Tax <- Tax_norm_PSM_HH[[i]][[i]]/Tax_norm_PSM_HH[[i]]$PSM
  Tax_norm_PSM_HH[[i]] <- Tax_norm_PSM_HH[[i]][!is.na(Tax_norm_PSM_HH[[i]]$New_Tax), ]
  
}


#Data frame for min and max hh, range, standard deviation and coefficient of variation
Tax_PSM_HH <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_PSM_HH) <- measu_PSM
rownames(Tax_PSM_HH) <- c("min", "max", "range", "sd", "cv")

for (i in measu_PSM){
  
  Tax_PSM_HH["min",i] <- Tax_norm_PSM_HH[[i]]$New_Tax[which.min(Tax_norm_PSM_HH[[i]]$HHStage)]
  Tax_PSM_HH["max",i] <- Tax_norm_PSM_HH[[i]]$New_Tax[which.max(Tax_norm_PSM_HH[[i]]$HHStage)]
  Tax_PSM_HH["range",i] <- Tax_PSM_HH["max",i] - Tax_PSM_HH["min",i]
  Tax_PSM_HH["sd",i] <- sd(Tax_norm_PSM_HH[[i]]$New_Tax)
  Tax_PSM_HH["cv",i] <- sd(Tax_norm_PSM_HH[[i]]$New_Tax)/mean(Tax_norm_PSM_HH[[i]]$New_Tax)
  
}
```

## Normalize for N.PS

### According to the real time

```{r}

measu_NPS <- c("C.N", "C.pPL", "C.Seg", "C.PS", "PSM", "N.pPL", "C.HF", "SEG")

Tax_norm_NPS1 <- vector("list", length = 8)

for (i in 1:length(Tax_norm_NPS1)){
  Tax_norm_NPS1[[i]] <- db_original_REF
}

names(Tax_norm_NPS1) <- measu_NPS


for (i in measu_NPS){
  
  Tax_norm_NPS1[[i]]$New_Tax <- Tax_norm_NPS1[[i]][[i]]/Tax_norm_NPS1[[i]]$N.PS
  Tax_norm_NPS1[[i]] <- Tax_norm_NPS1[[i]][!is.na(Tax_norm_NPS1[[i]]$New_Tax), ]
  
}
```

```{r}

p1_NPS <- tax_CHF_p(Tax_norm_NPS1[["C.N"]], 'C-N')+theme(axis.title.x = element_blank())

p2_NPS <- tax_CHF_p(Tax_norm_NPS1[["C.pPL"]], 'C-pPL')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3_NPS <- tax_CHF_p(Tax_norm_NPS1[["PSM"]], 'PSM')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4_NPS <- tax_CHF_p(Tax_norm_NPS1[["N.pPL"]], 'N-pPL')+theme(axis.title.x = element_blank())

p5_NPS <- tax_CHF_p(Tax_norm_NPS1[["SEG"]], 'SEG')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6_NPS <- tax_CHF_p(Tax_norm_NPS1[["C.Seg"]], 'C-Seg')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7_NPS <- tax_CHF_p(Tax_norm_NPS1[["C.HF"]], 'C-HF')

p8_NPS <- tax_CHF_p(Tax_norm_NPS1[["C.PS"]], 'C-PS')+theme(axis.title.y = element_blank())


svg(filename="RatioNPS.svg", 
    width=12, 
    height=10, 
    pointsize=14)

patchwork::wrap_plots(p1_NPS, p2_NPS, p3_NPS,
                      p4_NPS, p5_NPS, p6_NPS,
                      p7_NPS, p8_NPS, ncol = 3)

dev.off()
```

```{r}

#Data frame for min and max time, range, standard deviation and coefficient of variation
Tax_NPS_t <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_NPS_t) <- measu_NPS
rownames(Tax_NPS_t) <- c("min", "max", "range", "sd", "cv")

for (i in measu_NPS){
  
  Tax_NPS_t["min",i] <- Tax_norm_NPS1[[i]]$New_Tax[which.min(Tax_norm_NPS1[[i]]$Time)]
  Tax_NPS_t["max",i] <- Tax_norm_NPS1[[i]]$New_Tax[which.max(Tax_norm_NPS1[[i]]$Time)]
  Tax_NPS_t["range",i] <- Tax_NPS_t["max",i] - Tax_NPS_t["min",i]
  Tax_NPS_t["sd",i] <- sd(Tax_norm_NPS1[[i]]$New_Tax)
  Tax_NPS_t["cv",i] <- sd(Tax_norm_NPS1[[i]]$New_Tax)/mean(Tax_norm_NPS1[[i]]$New_Tax)
  
}
```

### According to the HH stage

```{r}

#Calculate the median for each measure
Tax_norm_NPS2 <- db_original_REF[!is.na(db_original_REF$HHStage), ]
Tax_norm_NPS2 <- Tax_norm_NPS2[, colnames(Tax_norm_NPS2) %in% c(measu_NPS, "N.PS", "HHStage")]
Tax_norm_NPS2$HHStage <- as.factor(Tax_norm_NPS2$HHStage)

Tax_norm_NPS2_ <- aggregate(. ~ HHStage, data = Tax_norm_NPS2, FUN = function(x) median(x, na.rm = TRUE), na.action = na.pass)
Tax_norm_NPS2_ <- Tax_norm_NPS2_[!is.na(Tax_norm_NPS2_$N.PS),]


#Normalize according NPS
Tax_norm_NPS_HH <- vector("list", length = 8)

for (i in 1:length(Tax_norm_NPS_HH)){
  Tax_norm_NPS_HH[[i]] <- Tax_norm_NPS2_
}

names(Tax_norm_NPS_HH) <- measu_NPS


for (i in measu_NPS){
  
  Tax_norm_NPS_HH[[i]]$New_Tax <- Tax_norm_NPS_HH[[i]][[i]]/Tax_norm_NPS_HH[[i]]$N.PS
  Tax_norm_NPS_HH[[i]] <- Tax_norm_NPS_HH[[i]][!is.na(Tax_norm_NPS_HH[[i]]$New_Tax), ]
  
}


#Data frame for min and max hh, range, standard deviation and coefficient of variation
Tax_NPS_HH <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_NPS_HH) <- measu_NPS
rownames(Tax_NPS_HH) <- c("min", "max", "range", "sd", "cv")

for (i in measu_NPS){
  
  Tax_NPS_HH["min",i] <- Tax_norm_NPS_HH[[i]]$New_Tax[which.min(Tax_norm_NPS_HH[[i]]$HHStage)]
  Tax_NPS_HH["max",i] <- Tax_norm_NPS_HH[[i]]$New_Tax[which.max(Tax_norm_NPS_HH[[i]]$HHStage)]
  Tax_NPS_HH["range",i] <- Tax_NPS_HH["max",i] - Tax_NPS_HH["min",i]
  Tax_NPS_HH["sd",i] <- sd(Tax_norm_NPS_HH[[i]]$New_Tax)
  Tax_NPS_HH["cv",i] <- sd(Tax_norm_NPS_HH[[i]]$New_Tax)/mean(Tax_norm_NPS_HH[[i]]$New_Tax)
  
}
```

## Normalize for SEG

### According to the real time

```{r}

measu_SEG <- c("C.N", "C.pPL", "C.Seg", "C.PS", "PSM", "N.pPL", "C.HF", "N.PS")

Tax_norm_SEG1 <- vector("list", length = 8)

for (i in 1:length(Tax_norm_SEG1)){
  Tax_norm_SEG1[[i]] <- db_original_REF
}

names(Tax_norm_SEG1) <- measu_SEG


for (i in measu_SEG){
  
  Tax_norm_SEG1[[i]]$New_Tax <- Tax_norm_SEG1[[i]][[i]]/Tax_norm_SEG1[[i]]$SEG
  Tax_norm_SEG1[[i]] <- Tax_norm_SEG1[[i]][!is.na(Tax_norm_SEG1[[i]]$New_Tax), ]
  
}
```

```{r}

p1_SEG <- tax_CHF_p(Tax_norm_SEG1[["C.N"]], 'C-N')+theme(axis.title.x = element_blank())

p2_SEG <- tax_CHF_p(Tax_norm_SEG1[["C.pPL"]], 'C-pPL')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p3_SEG <- tax_CHF_p(Tax_norm_SEG1[["PSM"]], 'PSM')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p4_SEG <- tax_CHF_p(Tax_norm_SEG1[["N.pPL"]], 'N-pPL')+theme(axis.title.x = element_blank())

p5_SEG <- tax_CHF_p(Tax_norm_SEG1[["N.PS"]], 'N-PS')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p6_SEG <- tax_CHF_p(Tax_norm_SEG1[["C.Seg"]], 'C-Seg')+theme(axis.title.x = element_blank(), axis.title.y = element_blank())

p7_SEG <- tax_CHF_p(Tax_norm_SEG1[["C.HF"]], 'C-HF')

p8_SEG <- tax_CHF_p(Tax_norm_SEG1[["C.PS"]], 'C-PS')+theme(axis.title.y = element_blank())


svg(filename="RatioSEG.svg", 
    width=12, 
    height=10, 
    pointsize=14)

patchwork::wrap_plots(p1_SEG, p2_SEG, p3_SEG,
                      p4_SEG, p5_SEG, p6_SEG,
                      p7_SEG, p8_SEG, ncol = 3)

dev.off()
```

```{r}

#Data frame for min and max time, range, standard deviation and coefficient of variation
Tax_SEG_t <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_SEG_t) <- measu_SEG
rownames(Tax_SEG_t) <- c("min", "max", "range", "sd", "cv")

for (i in measu_SEG){
  
  Tax_SEG_t["min",i] <- Tax_norm_SEG1[[i]]$New_Tax[which.min(Tax_norm_SEG1[[i]]$Time)]
  Tax_SEG_t["max",i] <- Tax_norm_SEG1[[i]]$New_Tax[which.max(Tax_norm_SEG1[[i]]$Time)]
  Tax_SEG_t["range",i] <- Tax_SEG_t["max",i] - Tax_SEG_t["min",i]
  Tax_SEG_t["sd",i] <- sd(Tax_norm_SEG1[[i]]$New_Tax)
  Tax_SEG_t["cv",i] <- sd(Tax_norm_SEG1[[i]]$New_Tax)/mean(Tax_norm_SEG1[[i]]$New_Tax)
  
}
```

### According to the HH stage

```{r}


#Calculate the median for each measure
Tax_norm_SEG2 <- db_original_REF[!is.na(db_original_REF$HHStage), ]
Tax_norm_SEG2 <- Tax_norm_SEG2[, colnames(Tax_norm_SEG2) %in% c(measu_SEG, "SEG", "HHStage")]
Tax_norm_SEG2$HHStage <- as.factor(Tax_norm_SEG2$HHStage)

Tax_norm_SEG2_ <- aggregate(. ~ HHStage, data = Tax_norm_SEG2, FUN = function(x) median(x, na.rm = TRUE), na.action = na.pass)
Tax_norm_SEG2_ <- Tax_norm_SEG2_[!is.na(Tax_norm_SEG2_$SEG),]


#Normalize according SEG
Tax_norm_SEG_HH <- vector("list", length = 8)

for (i in 1:length(Tax_norm_SEG_HH)){
  Tax_norm_SEG_HH[[i]] <- Tax_norm_SEG2_
}

names(Tax_norm_SEG_HH) <- measu_SEG


for (i in measu_SEG){
  
  Tax_norm_SEG_HH[[i]]$New_Tax <- Tax_norm_SEG_HH[[i]][[i]]/Tax_norm_SEG_HH[[i]]$SEG
  Tax_norm_SEG_HH[[i]] <- Tax_norm_SEG_HH[[i]][!is.na(Tax_norm_SEG_HH[[i]]$New_Tax), ]
  
}


#Data frame for min and max hh, range, standard deviation and coefficient of variation
Tax_SEG_HH <- data.frame(matrix(data=NA, nrow = 5, ncol = 8))
colnames(Tax_SEG_HH) <- measu_SEG
rownames(Tax_SEG_HH) <- c("min", "max", "range", "sd", "cv")

for (i in measu_SEG){
  
  Tax_SEG_HH["min",i] <- Tax_norm_SEG_HH[[i]]$New_Tax[which.min(Tax_norm_SEG_HH[[i]]$HHStage)]
  Tax_SEG_HH["max",i] <- Tax_norm_SEG_HH[[i]]$New_Tax[which.max(Tax_norm_SEG_HH[[i]]$HHStage)]
  Tax_SEG_HH["range",i] <- Tax_SEG_HH["max",i] - Tax_SEG_HH["min",i]
  Tax_SEG_HH["sd",i] <- sd(Tax_norm_SEG_HH[[i]]$New_Tax)
  Tax_SEG_HH["cv",i] <- sd(Tax_norm_SEG_HH[[i]]$New_Tax)/mean(Tax_norm_SEG_HH[[i]]$New_Tax)
  
}
```


